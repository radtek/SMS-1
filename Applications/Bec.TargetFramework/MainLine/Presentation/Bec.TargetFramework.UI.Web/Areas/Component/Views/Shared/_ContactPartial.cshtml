@using Bec.TargetFramework.Web.Framework.Extensions
@using Ext.Net
@using Ext.Net.MVC
@model Bec.TargetFramework.Entities.ContactDTO


<script>


    var comboSetter = function (comboBox, value) {
        var store = comboBox.store;
        var valueField = comboBox.valueField;
        var displayField = comboBox.displayField;

        var recordNumber = store.findExact(valueField, value, 0);

        if (recordNumber == -1)
            return -1;

        var displayValue = store.getAt(recordNumber).data[displayField];
        comboBox.setValue(value);
        comboBox.setRawValue(displayValue);
        comboBox.selectedIndex = recordNumber;
        return recordNumber;
    };


    var showFormItems = function (show) {
        if (show) {
            App.AddressForm.show();
            App.SaveAddress.show();
            App.AddAddress.hide();
            App.CancelAddress.show();

            enableDisableFormFields(false);
        } else {
            App.AddressForm.hide();
            App.AddressForm.getForm().reset();
            resetPostcodeResults();
            App.SaveAddress.hide();
            App.AddAddress.show();
            App.CancelAddress.hide();
            App.AddressList.clearValue();
            enableDisableFormFields(true);
        }


    };

    function enableDisableFormFields(enable) {

        var form = App.AddressForm.getForm();
        form.findField('Line1').setDisabled(enable);
        form.findField('Line2').setDisabled(enable);
        form.findField('Line3').setDisabled(enable);
        form.findField('City').setDisabled(enable);
        form.findField('County').setDisabled(enable);
        form.findField('BuildingName').setDisabled(enable);
        form.findField('AddressPostCode').setDisabled(enable);
        form.findField('AddressIsPrimaryAddressField').setDisabled(enable);
        form.findField('AddressNameField').setDisabled(enable);
        form.findField('AddressIDString').setDisabled(enable);
        form.findField('AddressTypeID').setDisabled(enable);
        form.findField('AddressCategoryID').setDisabled(enable);

    }

    var processSelectAddress = function () {

        var jsonString = App.AddressesJson.getValue();

        var results = JSON.parse(jsonString);

        var result = SearchForObject(results, 'AddressIDString', App.AddressList.getValue());

        if (result != null) {

            showFormItems(true);

            var form = App.AddressForm.getForm();

            form.findField('Line1').setValue(result.Line1);
            form.findField('Line2').setValue(result.Line2);
            form.findField('Line3').setValue(result.Line3);
            form.findField('City').setValue(result.City);
            form.findField('County').setValue(result.County);
            form.findField('BuildingName').setValue(result.BuildingName);
            form.findField('AddressPostCode').setValue(result.PostalCode);
            form.findField('AddressIsPrimaryAddressField').setValue(result.IsPrimaryAddress);
            form.findField('AddressNameField').setValue(result.Name);
            form.findField('AddressIDString').setValue(result.AddressIDString);
            form.findField('AddressID').setValue(result.AddressID);
            comboSetter(form.findField('AddressTypeID'), result.AddressTypeID);
            comboSetter(form.findField('AddressCategoryID'), result.AddressCategoryID);
        }
    };

    function selectFirstItem() {
        if (App.AddressList.getStore() != null && App.AddressList.getStore().getCount() > 0) {
            App.AddressList.setValue(App.AddressList.getStore().getAt('0').get('AddressIDString'));
            processSelectAddress();
        }
    }

    var resetPostcodeResults = function () {
        App.AddressForm.getForm().findField('PostCodeResults').getStore().removeAll();
        App.AddressForm.getForm().findField('PostCodeResults').hide();
    };

    var processSaveAddress = function () {
        showFormItems(false);
        App.AddressList.getStore().load();
    };

    var processAddAddress = function () {
        App.AddressForm.getForm().reset();
        resetPostcodeResults();
        showFormItems(true);
    };

    var processCancelAddress = function () {
        showFormItems(false);
    };


</script>



@(Html.X().Panel().Layout(LayoutType.Column).AutoScroll(true).Title(ViewBag.contactPartialTitle).Padding(5)
      .Items
      (
          Html.X().HiddenFor(model => model.ContactJson),
              Html.X().HiddenFor(model => model.AddressesJson),
              Html.X() 
                  .Container()
                  .Layout(LayoutType.Form)
                  .ColumnWidth(1)
                  .Padding(2)
                  .Items(
                      Html.X().MultiSelect().ID("ContactFormErrors").Hidden(true)),
          Html.X().Container().Layout(LayoutType.Form).ColumnWidth(0.25).Padding(5)
              .Items
              (
                      Html.X().ComboBoxFor(model => model.OrganisationUnitID).ApplyComboxDefaults(Razor.ApplyComboBoxDefaults)
                              .FieldLabel("Organisation Unit").Items(Model.OrgansationsUnits),
                      Html.X().ComboBoxFor(model => model.OrganisationBranchID).Items(Model.OrgansationsBranches).ApplyComboxDefaults(Razor.ApplyComboBoxDefaults)
                              .FieldLabel("Organisation Branch"),
                  Html.X().TextFieldFor(model => model.ContactName).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                  Html.X().TextFieldFor(model => model.Salutation).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                  Html.X().TextFieldFor(model => model.FirstName).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                  Html.X().TextFieldFor(model => model.MiddleName).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                  Html.X().TextFieldFor(model => model.LastName).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                  Html.X().TextFieldFor(model => model.NickName).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                  Html.X().DateFieldFor(model => model.BirthDate).ApplyDateFieldDefaults(Razor.ApplyDateFieldDefaults),
                  Html.X().ComboBoxFor(model => model.GenderTypeID).ApplyComboxDefaults(Razor.ApplyComboBoxClassificationDefaults)
                      .FieldLabel("Gender")
                      .Store(Razor.CreateClassificationStore("GenderType", Url.Action("ReadData", "Reference", new { area = "" }))),
                  Html.X().ComboBoxFor(model => model.EducationTypeID).ApplyComboxDefaults(Razor.ApplyComboBoxClassificationDefaults)
                      .FieldLabel("Education")
                      .Store(Razor.CreateClassificationStore("EducationType", Url.Action("ReadData", "Reference", new { area = "" }))),
                  Html.X().TextFieldFor(model => model.JobTitle).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                  Html.X().TextFieldFor(model => model.Department).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults)
              )
              ,
                  Html.X().Container().Layout(LayoutType.Form).Border(true).ColumnWidth(0.25).Padding(5)
                  .Items(
                      Html.X().TextFieldFor(model => model.WebSiteURL).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                         Html.X().ComboBoxFor(model => model.ContactTypeID).ApplyComboxDefaults(Razor.ApplyComboBoxClassificationDefaults)
                              .FieldLabel("Type")
                              .Store(Razor.CreateClassificationStore("ContactType", Url.Action("ReadData", "Reference", new { area = "" }))),
                          Html.X().ComboBoxFor(model => model.ContactCategoryID).ApplyComboxDefaults(Razor.ApplyComboBoxClassificationDefaults)
                                  .FieldLabel("Category")
                              .Store(Razor.CreateClassificationStore("ContactCategory", Url.Action("ReadData", "Reference", new { area = "" }))),
                          Html.X().ComboBoxFor(model => model.CustomerTypeID).ApplyComboxDefaults(Razor.ApplyComboBoxClassificationDefaults)
                                  .FieldLabel("Customer Type")
                              .Store(Razor.CreateClassificationStore("CustomerType", Url.Action("ReadData", "Reference", new { area = "" }))),

                            Html.X().TextFieldFor(model => model.EmailAddress1).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                                Html.X().TextFieldFor(model => model.EmailAddress2).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                            Html.X().TextFieldFor(model => model.Telephone1).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                                    Html.X().TextFieldFor(model => model.Telephone2).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                            Html.X().TextFieldFor(model => model.MobileNumber1).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults),
                            Html.X().TextFieldFor(model => model.MobileNumber2).ApplyTextFieldDefaults(Razor.ApplyTextFieldDefaults)
                      )





              , Html.X().Panel().ColumnWidth(0.5).Padding(5)
                      .Title("Address Management").Border(true)
                  .Items
                  (

                                  Html.X().FormPanel().ID("AddressForm").Border(false)
                                     .ItemsFromPartial("_AddressPartial", Model.CurrentAddress).Hidden(true)
                                 )
                          .DockedItems(Html.X().Toolbar()
                              .Items
                              (
                                  Html.X().ComboBox().Items(Model.AddressListItems).ID("AddressList").TriggerAction(TriggerAction.All)
                                      .FieldLabel("").Editable(false).QueryMode(DataLoadMode.Local)
                                      .DisplayField("Name")
                                      .ValueField("AddressIDString")
                                      .Store(Html.X().Store()
                                          .AutoLoad(true)
                                              .Parameters(e => e.Add(Html.X().StoreParameter().Name("addressesJsonValue").Value("App.ContactForm.getForm().findField('AddressesJson').getValue()").Mode(ParameterMode.Raw)))
                                          .Model(Html.X()
                                              .Model()
                                              .IDProperty("AddressIDString")
                                              .Fields(
                                                  new ModelField("Name", ModelFieldType.String),
                                                  new ModelField("AddressIDString", ModelFieldType.String)
                                              ))
                                          .Proxy(Html.X()
                                              .AjaxProxy()
                                              .Url(Url.Action("GetAddresses", "Address", new { area = "Component" }))
                                              .Reader(new JsonReader.Builder().Root("data"))))
                                      .EmptyText("Select an Address or Add..")
                                      .Listeners(l => l.Select.Handler = "processSelectAddress();")
                                  ,
                                  Html.X().Button().Text("Add").ID("AddAddress")
                                      .Listeners(l => l.Click.Handler = "processAddAddress();"),
                                  Html.X().Button().Text("Save Address").Hidden(true).ID("SaveAddress")
                                      .DirectEvents(de =>
                                      {
                                          de.Click.Before = "return App.AddressForm.isValid();";
                                          de.Click.Url = Url.Action("AddAddressToContact", "Address", new { area = "component", jsonField = "AddressesJson" });
                                          de.Click.ExtraParams.Add(new Parameter("addressesJsonValue", "App.ContactForm.getForm().findField('AddressesJson').getValue()", ParameterMode.Raw));
                                          de.Click.ExtraParams.Add(new Parameter("jsonField", "AddressesJson", ParameterMode.Value));
                                          de.Click.Success = "processSaveAddress();";
                                      }),
                                  Html.X().Button().Text("Cancel").Hidden(true).ID("CancelAddress")
                                      .Listeners(l => l.Click.Handler = "processCancelAddress();")
                              )
                          )
                  )
)