
@using Ext.Net
@using Ext.Net.MVC
@using Bec.TargetFramework.Web.Framework.Extensions
@model Bec.TargetFramework.Entities.vOrganisationDTO

<script>
    function closeAddWindowAndUpdateBranch() {
        App.AddOrganisationBranchGrid.getStore().load();
        App.OrganisationBranchAddWindow.close();
    }

    function closeEditWindowAndUpdateBranch() {
        App.AddOrganisationBranchGrid.getStore().load();
        App.OrganisationBranchEditWindow.close();
    }

    function deleteUpdateBranch() {
        App.AddOrganisationBranchGrid.getStore().load();
        App.OrganisationBranchEditWindow.close();
    }
</script>

@(Html.X()
    .FormPanel()
      .ID("BranchesAndUsersForm")
      .ApplyFormPanelDefaults(Razor.ApplyFormPanelDefaults)
      .Items(Html.X()
      .Container()
      .Padding(5)
      .Items( Html.X().Container().Padding(2)
                                .Items(
Html.X().MultiSelect().ID("OrganisationBranchErrors").Hidden(true)),
                  Html.X()
                      .GridPanel()
                      .Padding(5)
                      .ID("AddOrganisationBranchGrid")
                      .Store(Html.X()
                          .Store()
                          .AutoLoad(true)
                          .RemoteSort(false)
                          .Model(Html.X()
                              .Model()
                              .Fields(fields =>
                              {
                                  fields.Add(new ModelField("ContactName"));
                                  fields.Add(new ModelField("ContactID"));
                                  fields.Add(new ModelField("OrganisationID"));
                              }))
                          .Proxy(proxy => proxy.Add(Html.X()
                              .AjaxProxy()
                                  .Url(Url.Action("GetBranchesforOrg", "BranchOrganisation", new { id = Model.OrganisationID, area = "Component" }))
                                  .Reader(reader => reader.Add(Html.X().JsonReader().Root("data").IDProperty("BranchOrganisationID")))))
                             .MessageBusListeners(ml =>
                          {
                              ml.Add(new MessageBusListener { Name = "AddOrganisationBranch", Handler = "App.OrganisationBranchAddWindow.close();  App.AddOrganisationBranchGrid.getStore().load();" });
                              ml.Add(new MessageBusListener { Name = "DeleteOrganisationBranch", Handler = "App.AddOrganisationBranchGrid.getStore().load();" });
                              ml.Add(new MessageBusListener { Name = "EditOrganisationBranch", Handler = "App.OrganisationBranchEditWindow.close();  App.AddOrganisationBranchGrid.getStore().load();" });
                          }))
                      .ColumnModel(
                              Html.X().Column().Text("Name").DataIndex("ContactName").Width(200),
                              Html.X()
                                  .ImageCommandColumn()
                                  .Commands(
                                      Html.X()
                                          .ImageCommand()
                                          .CommandName("Edit")
                                          .Icon(Icon.ApplicationEdit)
                                          .ToolTip(tt => tt.Text = "Edit")
                                  )
                                  .DirectEvents(de =>
                                  {
                                      de.Command.Method = HttpMethod.POST;
                                      de.Command.Url = Url.Action("ShowEditOrganisationBranchWindowWithinAdmin", "BranchOrganisation", new { area = "Component", id = Model.OrganisationID });
                                      de.Command.ExtraParams.Add(new Parameter("branchId", "record.data.OrganisationID", ParameterMode.Raw));
                                      de.Command.ExtraParams.Add(new Parameter("contactId", "record.data.ContactID", ParameterMode.Raw));
                                      de.Command.ExtraParams.Add(new Parameter("containerId", "AdministrationCenterPanel", ParameterMode.Value));
                                      de.Command.Success = "App.AddOrganisationBranchGrid.getStore().load();";
                                  })
                              ,
                          Html.X()
                              .ImageCommandColumn()
                              .ID("BranchDelete")
                              .Commands(
                                  Html.X()
                                      .ImageCommand()
                                      .CommandName("Delete")
                                      .Icon(Icon.ApplicationDelete)
                                      .ToolTip(tt => tt.Text = "Delete")
                              ).DirectEvents(de =>
                              {
                                  de.Command.Method = HttpMethod.GET;
                                  de.Command.Url = Url.Action("DeleteOrganisationBranch", "BranchOrganisation", new { area = "Component" });
                                  de.Command.Confirmation.ConfirmRequest = true;
                                  de.Command.Confirmation.Message = "Are you sure you want to delete this branch?";
                                  de.Command.ExtraParams.Add(new Parameter("id", "record.data.ContactID", ParameterMode.Raw));
                                  de.Command.Success = "App.AddOrganisationBranchGrid.getStore().load();";
                              })
                      )

                                                     .BottomBar(
                       Html.X()
                           .PagingToolbar()
                           .DisplayInfo(true)
                           .DisplayMsg("Displaying Branches {0} - {1} of {2}")
                           .EmptyMsg("No branches to display"))
                      .DockedItems(
                          Html.X().Toolbar()
                              .Dock(Dock.Top)
                              .Items(
                                  Html.X()
                                      .Button()
                                      .Text("Add Branch")
                                      .DirectEvents(de =>
                                      {
                                          de.Click.Method = HttpMethod.POST;
                                          de.Click.Url = Url.Action("ShowAddOrganisationBranchWindowWithinAdmin", "BranchOrganisation", new { area = "Component", id = Model.OrganisationID });
                                      })
                                  ,
                                      Html.X().ToolbarFill(),
                                      Html.X().Button().ApplyButtonDefaults(Razor.ApplyCancelButtonDefaults).ID("CancelBranch")
                                               .DirectClickUrl(Url.Action("OrganisationManagement", "Organisation", new { area = "Component", containerId = "AdministrationCenterPanel" }))))
                      .AutoDoLayout(true)
                   )
                      )
                     
)
